# 0004: Preferences sync hook

## Context

Bridge between Convex DB user record, Zustand store, i18next, and next-themes. On mount loads DB prefs into store; reactively syncs store changes to i18next and next-themes.

## Dependencies

- 0001 (i18n instance)
- 0002 (user schema with language/theme)
- 0003 (preferences store)

## Files

- `src/hooks/use-sync-preferences.ts` (new)
- `src/routes/_authenticated.tsx` (edit — wire hook)

## Requirements

### Hook: `useSyncPreferences()`

1. Read user from `useUser()` hook
2. Read store values via `useLanguage()`, `usePreferredTheme()`
3. Read store actions via `usePreferencesActions()`
4. Get `i18n` from `useTranslation()`
5. Get `setTheme` from `useTheme()` (next-themes)

**On mount (once):**

- If `user.language` exists and differs from store → `setPreferences({ language, theme })`
- Use a `useRef` flag to prevent re-running

**Reactive effects:**

- When `language` changes → `i18n.changeLanguage(language)` + `document.documentElement.lang = language`
- When `theme` changes → `setTheme(theme)` (next-themes)

### Layout integration

In `_authenticated.tsx`, add a `SyncPreferences` wrapper component inside `AuthenticatedLayout` that calls `useSyncPreferences()` and renders `<Outlet />`. Hooks cannot be called conditionally, so this component must always render.

## No-gos

- Do not call Convex mutations from this hook (DB save happens in the dropdown component)
- Do not re-sync on every render (guard with ref)

## Definition of Done

- [ ] `src/hooks/use-sync-preferences.ts` created
- [ ] DB preferences load into Zustand store on first authenticated render
- [ ] Language changes update `i18n.language` and `<html lang="...">`
- [ ] Theme changes update next-themes
- [ ] `_authenticated.tsx` wires the hook via wrapper component
- [ ] No infinite re-render loops
